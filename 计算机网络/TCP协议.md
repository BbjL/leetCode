###### TCP协议
运输层协议
IP 协议只是一个地址协议，并不保证数据包的完整。如果路由器丢包（比如缓存满了，新进来的数据包就会丢失），就需要发现丢了哪一个包，以及如何重新发送这个包。这就要依靠 TCP 协议。
因此，TCP 协议的作用是，保证数据通信的完整性和可靠性，防止丢包。

##### 需要了解的几个标志位
- SYN 同步序列号。
    >只有从每一端发送的第一个数据包应该设置此标志。其他一些标志和字段会根据此标志更改含义，有些仅在设置时有效，有些仅在明确时有效。  
    在建立连接时用来同步序号。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若同意连接，则应在响应报文段中使SYN=1和ACK=1。因此，SYN=1就表示一个连接请求或连接接受报文
- ACK 确认标志位
    > 仅当ACK=1时确认字段才有效。当ACK=0时，确认号无效。TCP规定，在连接建立后所有传送的报文都必须将ACK标志位值为1
- FIN 结束标志。
- RST 复位标志。用于复位相应的TCP连接。
- ack 确认号,即下图中的序号（发给接受方下个数据包端编号）
- seq 序列号，即下图中的确认号（当前数据包端编号）

##### TCP报文格式
![TCP报文段的首部格式](https://img-blog.csdn.net/20180324192146298?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzMyOTk4MTUz/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

##### 特点
- 
- 慢启动
    

##### 三个主要过程
- **建立连接**
    ![TCP三次握手过程](https:////upload-images.jianshu.io/upload_images/2964446-aa923712d5218eeb.png?imageMogr2/auto-orient/strip|imageView2/2/w/517/format/webp)
   + 建立TCP连接，最终将交换三次TCP数据报，即进行三次握手。
   + 第一次握手：客户端将SYN置为1，表示请求TCP连接，同时随机设置一个序列号，并将该数据包发送给Server，Client进入SYN_SENT状态，等待Server确认。
   + 第二次握手：Server收到数据包后由标志位SYN=1知道Client请求建立连接，Server将标志位SYN和ACK都置为1,将确认号ack=J+1，随机产生一个值seq=K，并将该数据包发送给Client以确认连接请求，Server进入SYN_RCVD状态
   + 第三次握手：Client收到确认后，检查ack是否为J+1，ACK是否为1，如果正确则将标志位ACK置为1，ack=K+1，并将该数据包发送给Server，Server检查ack是否为K+1，ACK是否为1，如果正确则连接建立成功，Client和Server进入ESTABLISHED状态，完成三次握手，随后Client与Server之间可以开始传输数据了


- **数据传输**
![报文传输过程](https://img-blog.csdn.net/20180828140054245?watermark/2/text/aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoYW5naGFuZ3NoaQ==/font/5a6L5L2T/fontsize/400/fill/I0JBQkFCMA==/dissolve/70)

（1）假设主机A向主机B发送1800字节的数据，主机B向主机A发送1000字节的数据。

（2）主机A取seq=8001作为第一个字节的编号(seq不一定从0开始，0-(2^32 - 1)之间的随机数)，由于数据长度是1800，字节编号就是8001-9801。同理主机B编号是18001-19000。

（3）当对字节编号后，TCP就给每个报文分配一个序号，该序号即这个报文中的第一个字节的编号，在图中主机A数据被拆分两个报文段（主机A限定发送有效值1000字节，所以会分两段发送一个1000字节，一个800字节），因此第一段报文序号是seq=8001，第二段报文序号seq=9001。同理主机B一段报文发送，序号是seq=18001。

（4）接收端接收到报文需要进行确认，TCP确认号被定义下一个希望接收到的字节的编号，所以当主机B成功接收到主机A发送的第二段报文时，发现报文的字节编号9001-9800，所以主机B发送给主机A确认序号ack=9801。同理主机A接收到主机B发送的报文字节编号是18001-19000，会给主机B发送确认报文，确认序号ack=19001。

（5）报文传输完成，这里主机A最后一次只发送一个ack，代表主机A已经没有数据发送给主机B了。为了提高TCP传输数据效率，接收端主机不会对发送端主机发送的每一段报文都进行报文确认，而是当同时接收到多个报文后再发送确认报文ack。

- **断开连接**
    ![img](https://pic2.zhimg.com/80/v2-c7d4b5aca66560365593f57385ce9fa9_720w.jpg)
    + 第一次挥手：客户端FIN置位1，随机产生seq=u，发送到服务端，客户端进入FIN_WAIT状态。
    + 第二次挥手，服务端接受到FIN报文段后，服务端将ACK=1，ack=u+1，随机产生seq=v的确认报文，发送到客户端，服务端进入CLOSE_WAIT状态，客户端进入FIN_WAIT2状态。
    + 第三次挥手，服务端将所有报文发送传输完毕后，发送FIN=1，ACK=1，seq=w，ack=u+1，给客户端发送确认关闭连接报文，服务端进入LAST_ACK状态，客户端进入TIME_WAITCLOSED状态
    + 客户端端等待2个MSL时间后，发送ACK=1，seq=u+1


- **数据包遗失处理**
TCP 协议可以保证数据通信的完整性，这是怎么做到的？
前面说过，每一个数据包都带有下一个数据包的编号。如果下一个数据包没有收到，那么 ACK 的编号就不会发生变化。
举例来说，现在收到了4号包，但是没有收到5号包。ACK 就会记录，期待收到5号包。过了一段时间，5号包收到了，那么下一轮 ACK 会更新编号。如果5号包还是没收到，但是收到了6号包或7号包，那么 ACK 里面的编号不会变化，总是显示5号包。这会导致大量重复内容的 ACK。
如果发送方发现收到三个连续的重复 ACK，或者超时了还没有收到任何 ACK，就会确认丢包，即5号包遗失了，从而再次发送这个包。通过这种机制，TCP 保证了不会有数据包丢失。
![img](http://www.ruanyifeng.com/blogimg/asset/2017/bg2017060811.png)

##### 拓展：SYN攻击
 > 在三次握手过程中，Server发送SYN-ACK之后，收到Client的ACK之前的TCP连接称为半连接（half-open connect），此时Server处于SYN_RCVD状态，当收到ACK后，Server转入ESTABLISHED状态。SYN攻击就是Client在短时间内伪造大量不存在的IP地址，并向Server不断地发送SYN包，Server回复确认包，并等待Client的确认，由于源地址是不存在的，因此，Server需要不断重发直至超时，这些伪造的SYN包将产时间占用未连接队列，导致正常的SYN请求因为队列满而被丢弃，从而引起网络堵塞甚至系统瘫痪。SYN攻击时一种典型的DDOS攻击，检测SYN攻击的方式非常简单，即当Server上有大量半连接状态且源IP地址是随机的，则可以断定遭到SYN攻击了，使用如下命令可以让之现行：

 ##### 慢启动和拥塞控制

##### 几个问题
1. 为什么建立连接时要进行三次握手，而不是进行两次、一次握手或者四次握手？
 > ____如果进行一次握手，客户端将不知道是否已经建立连接，如果连接未建立，客户端将会一直等待直到超时，这会造成客户端造成无意义的开销。再者，如果受到SYN攻击，服务器将不断创建新的连接，将会导致服务器崩溃。
____如果进行两次握手， 服务端发送完确认报文，仅仅只知道了客户端的发送能力，但客户端的接收能力并未得到确认，服务端讲会在再次发送确认报文，等待客户端的确认。然而此时，进行如果进行两次报文建立TCP连接，在第二次握手时已经建立完连接，并将数据发送到服务端，之后释放TCp连接。只是服务端并不知道，造成服务端资源的浪费
____进行三次握手，要从两个端的发送能力和接受能力来讲，第一次握手，服务器端确认客户端的发送能力，第二次握手，客户端确认发送端的接受能力和发送能力，第三次握手，服务端确认客户端的接收能力。

2. 为什么建立连接握手三次，而释放连接需要进行四次挥手？
>  这是由于在受到客户端断开请求时，服务端不能马上发送断开连接，由于可能还存在未发送完端报文段，因此只能先发送确认请求，等待所有报文段发送完毕后，在发送确认断开报文。

3. 为什么客户端在收到确认断开报文段后仍然需要等待2个MSL时间？

> MSL是Maximum Segment Lifetime的英文缩写，可译为“最长报文段寿命”，它是任何报文在网络上存在的最长时间，超过这个时间报文将被丢弃。  
1、因为客户端在发送最后端确认报文后，并不能确定服务端是否已经接收,如果最后一个确认报文段丢失，服务端将会由于超时再次发送FIN报文段到客户端，让客户端重新发送确认报文，同时刷新等待时间。如果不等待两个MSL时间立即关闭连接，服务端将无法正常进入关闭连接状态。
2、防止下一次报文被污染，等待两个MSL时间可以使本连接中的全部报文段被从网络中消失，这样可以使新端连接不会出现旧的连接报文

4. 在建立连接时ack=seq+1
> ack确认号表示接收方下一个报文段段的位置,由于请求报文段中不允许携带数据，但是要消耗掉一个序号


参考连接：
[五层网络协议，各层功能，各层协议](https://blog.csdn.net/qq_22238021/article/details/80279001)
[TCP 协议简介](http://www.ruanyifeng.com/blog/2017/06/tcp-protocol.html)
[浅谈TCP拥塞控制：慢启动和拥塞避免、快速重传和快速恢复](https://blog.csdn.net/qq_42214953/article/details/105832303)